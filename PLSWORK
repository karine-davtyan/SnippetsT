<?xml version="1.0" encoding="UTF-8"?>
<purity-config xmlns:comm="http://www.ataccama.com/purity/comment"
               version="14.5.1.231204-6829-cc8f270d">
  <references/>
  <component-mappings>
    <propertyMappings/>
  </component-mappings>

  <!-- JSON Reader step -->
  <step id="Json Reader" mode="NORMAL"
        className="com.ataccama.dqc.tasks.io.json.reader.JsonReader">
    <properties fileName="./sz_nb_ext.json" encoding="UTF-8">
      <dataStreams>

        <!-- 1) Top-level location object -->
        <jsonStreamConfig path="$.data.location" name="location">
          <attributes>
            <attribute path="draftVersion.name" name="location_name" type="STRING"/>
          </attributes>
          <shadowColumns>
            <shadowColumnDef name="location_name" defaultExpression="location_name" type="STRING"/>
          </shadowColumns>
          <dataStreams>

            <!-- 2) One record per catalog item -->
            <jsonStreamConfig path="draftVersion.catalogItems.edges" name="items">
              <attributes>
                <attribute path="node.gid"                         name="item_gid"         type="STRING"/>
                <attribute path="node.draftVersion.name"           name="item_name"        type="STRING"/>
                <attribute path="node.publishedVersion.description" name="item_description" type="STRING"/>
              </attributes>
              <shadowColumns>
                <shadowColumnDef name="location_name"
                                 defaultExpression="location.location_name"
                                 type="STRING"/>
              </shadowColumns>
              <dataStreams>

                <!-- 3) One record per attribute on each item -->
                <jsonStreamConfig path="node.publishedVersion.attributes.edges" name="attributes">
                  <attributes>
                    <attribute path="node.draftVersion.name"        name="attribute_name"        type="STRING"/>
                    <attribute path="node.draftVersion.description" name="attribute_description" type="STRING"/>
                  </attributes>
                  <shadowColumns>
                    <shadowColumnDef name="location_name"
                                     defaultExpression="items.location_name"
                                     type="STRING"/>
                    <shadowColumnDef name="item_gid"
                                     defaultExpression="items.item_gid"
                                     type="STRING"/>
                    <shadowColumnDef name="item_name"
                                     defaultExpression="items.item_name"
                                     type="STRING"/>
                  </shadowColumns>
                </jsonStreamConfig>

              </dataStreams>
            </jsonStreamConfig>

          </dataStreams>
        </jsonStreamConfig>

      </dataStreams>
    </properties>
    <visual-constraints layout="horizontal" bounds="48,312,629,544"/>
  </step>

  <!-- Write items -->
  <step id="ItemsOut" mode="NORMAL"
        className="com.ataccama.dqc.tasks.io.text.write.TextFileWriter">
    <properties fileName="./items_out.csv"
                fieldSeparator=";"
                writeHeader="true"
                writeAllColumns="true"
                encoding="UTF-8"
                lineSeparator="\r\n"/>
  </step>

  <!-- Write attributes -->
  <step id="AttributesOut" mode="NORMAL"
        className="com.ataccama.dqc.tasks.io.text.write.TextFileWriter">
    <properties fileName="./attributes_out.csv"
                fieldSeparator=";"
                writeHeader="true"
                writeAllColumns="true"
                encoding="UTF-8"
                lineSeparator="\r\n"/>
  </step>

  <!-- Connect endpoints -->
  <connection className="com.ataccama.dqc.model.elements.connections.StandardFlowConnection">
    <source step="Json Reader" endpoint="items"/>
    <target step="ItemsOut"    endpoint="in"/>
  </connection>
  <connection className="com.ataccama.dqc.model.elements.connections.StandardFlowConnection">
    <source step="Json Reader" endpoint="attributes"/>
    <target step="AttributesOut" endpoint="in"/>
  </connection>

</purity-config>
